# This makefile was generated by autochaos 0.2.0. Please do not
# tamper with it unless you are very certain about what you are doing.

ALL_ARGUMENTS = 

PREFIX = /mnt/chaos
PACKAGE = ipv4

# Compiler flags.

CFLAGS = -Wall -W -Wshadow -Wpointer-arith -Waggregate-return \
-Wstrict-prototypes -Wredundant-decls -Winline -Wmissing-prototypes \
-Werror -Wcast-align -Wbad-function-cast -Wmissing-noreturns -Wsign-compare \
-Wmissing-declarations -pipe \
-Wnested-externs -O3 -fno-builtin -funsigned-char -g $(EXTRA_CFLAGS) $(DEFINES)

INCLUDES = \
-I. -I$(PREFIX)/data/programming/c/headers

ALL_OBJECTS = \
./arp.o \
./dhcp.o \
./forward.o \
./icmp.o \
./ipv4.o \
./route.o \
./socket.o \
./tcp.o \
./udp.o

STATIC_LIBRARY_PATH = $(PREFIX)/data/programming/libraries/static

# Ideally, this would be -lwhatever, but we have not started patching
# the GNU tools yet...

LIBS = \
$(STATIC_LIBRARY_PATH)/library_ipc.a \
$(STATIC_LIBRARY_PATH)/library_log.a \
$(STATIC_LIBRARY_PATH)/library_string.a \
$(STATIC_LIBRARY_PATH)/library_system.a \
$(STATIC_LIBRARY_PATH)/library_memory.a \
$(STATIC_LIBRARY_PATH)/library_network.a \
$(STATIC_LIBRARY_PATH)/library_mutex.a \
$(STATIC_LIBRARY_PATH)/library_random.a \
$(STATIC_LIBRARY_PATH)/library_list.a \
$(STATIC_LIBRARY_PATH)/library_time.a 

OBJECTS =  \
arp.o \
dhcp.o \
forward.o \
icmp.o \
ipv4.o \
route.o \
socket.o \
tcp.o \
udp.o


SOURCES =  \
arp.c \
dhcp.c \
forward.c \
icmp.c \
ipv4.c \
route.c \
socket.c \
tcp.c \
udp.c

HEADER_PATH = $(PREFIX)/data/programming/c/headers/$(PACKAGE)/.

# TODO: Those should be overridable.

CC = gcc
NASM = nasm
AR = ar
RANLIB = ranlib
GZIP = gzip -f

%.o: %.c
	@echo Compiling $<...
	@$(CC) -o $(@) $(CFLAGS) $(INCLUDES) $(DEFS) -c $<
	@$(CC) -M $< $(CFLAGS) $(INCLUDES) $(DEFS) > $(*F).dep

%.o: %.S
	@echo Compiling $<...
	@$(CC) -o $(@) $(CFLAGS) $(INCLUDES) $(DEFS) -c $<
	@$(CC) -M $< $(CFLAGS) $(INCLUDES) $(DEFS) > $(*F).dep

%.o: %.asm
	$(NASM) -o $(@) $< -f elf

.PHONY: splash all clean install package-source

all: splash makefile ipv4

clean: makefile
	rm -f ipv4
	rm -f $(OBJECTS)
	rm -f *.dep
	-$(MAKE) clean-local
makefile: configure
	@./configure

splash:
	@echo -e "\n  Compiling server: ipv4...\n"

configure: autochaos.rules
	@autochaos


LDFLAGS = $(PREFIX)/data/programming/c/startup/startup.o \
-nostdlib -Wl,-T,$(PREFIX)/data/programming/linker/chaos.ld -lgcc $(EXTRA_LDFLAGS)

ipv4: $(OBJECTS)
	@echo "Linking..."
	@$(CC) -o $(@) $(OBJECTS) $(LIBS) $(LDFLAGS)

install: all
	mkdir -p $(PREFIX)/system/servers
	cp ipv4 $(PREFIX)/system/servers
	strip -R .note -R .comment -R .eh_frame $(PREFIX)/system/servers/ipv4
	$(GZIP) $(PREFIX)/system/servers/ipv4 # > $(PREFIX)/system/servers/ipv4.gz

package-source:
	mkdir -p /root/Development/chaos/servers/network/ipv4/package-source/.
	-cp -f autochaos.rules changelog configure README AUTHORS TODO INSTALL /root/Development/chaos/servers/network/ipv4/package-source/.
	-cp -f makefile.template $(EXTRA_FILES) /root/Development/chaos/servers/network/ipv4/package-source/.
	for source in $(SOURCES) ; do cp $$source /root/Development/chaos/servers/network/ipv4/package-source/. ; done
package-check: package-source
	     cd package-source && ./configure $(ALL_ARGUMENTS) && $(MAKE) && $(MAKE) clean
	     find package-source -name makefile -exec rm {} ';'
	     rm package-source/config.h
package: package-check
	rm -rf ipv4-0.0.1
	mv package-source ipv4-0.0.1
	tar cvIf ipv4-0.0.1.tar.bz2 ipv4-0.0.1
	     
-include arp.dep
-include dhcp.dep
-include forward.dep
-include icmp.dep
-include ipv4.dep
-include route.dep
-include socket.dep
-include tcp.dep
-include udp.dep

