#! /usr/bin/perl -w

# Abstract: Script for configuring this package.

# Copyright 2000 chaos development. This script is in the public domain.

# Please note that this script was automatically generated by
# autochaos 0.2.0. It should not be modified. Do the changes you
# want in autochaos instead.

use strict;
use POSIX;

my $default_root = "/";
my $chaos_root = undef;
my @libraries = ();
my @headers = ();
my @sources = ();
my @objects = ();
my @deps = ();
my $MAKEFILE;
my $TEMPLATE;
my $root_dir = getcwd ();
my %options = 
(
);

my $install_prefix_flag = 0;

foreach my $argument (@ARGV)
{
  if ($install_prefix_flag eq 1)
  {
    $default_root = $argument;
    $install_prefix_flag = 0;
  }
  else
  {
    if ($argument eq '--install-prefix')
    {
      $install_prefix_flag = 1;
    }
    elsif ($argument =~ m/--enable-.*$/)
    {
      (my $option) = ($argument =~ m/--enable-(.*)$/);

      if ($options{$option})
      {
        $options{$option} = 'TRUE';
      }
      else
      {
        print "Unrecognised command line option.\n";
        exit 1;
      }
    }
    elsif ($argument =~ m/--disable-.*$/)
    {
      (my $option) = ($argument =~ m/--disable-(.*)$/);

      if ($options{$option})
      {
        $options{$option} = 'FALSE';
      }
      else
      {
        print "Unrecognised command line option.\n";
        exit 1;
      }
    }
    else
    {
      print "Unrecognised command line option.\n";
      exit 1;
    }
  }
}

if ($install_prefix_flag eq 1)
{
  print "Malformed --install-prefix command option. Value missing.\n";
  exit 1;
}

print "\n  Configuring server: ipv4...\n\n";

print ("Detecting chaos root...\n");

print "Trying default root ($default_root)... ";

if (-d "$default_root/system/kernel")
{
  print "found.\n";
  $chaos_root = $default_root;
}
else
{
  print "not found.\n";

  print "Trying /mnt/chaos... ";

  if (-d "/mnt/chaos/system/kernel")
  {
    print "found.\n";
    $chaos_root = "/mnt/chaos";
  }

  unless ($chaos_root)
  {
    $chaos_root = "/tmp/chaos";
    print "not found.\nFalling back to $chaos_root.\n";
  }
}

print ("Checking for ipc library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_ipc.a")
{
  print ("found.\n");

  push (@libraries, "ipc");
}
else
{
  print ("not found.\n");
  print ("\nError: ipc is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for log library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_log.a")
{
  print ("found.\n");

  push (@libraries, "log");
}
else
{
  print ("not found.\n");
  print ("\nError: log is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for string library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_string.a")
{
  print ("found.\n");

  push (@libraries, "string");
}
else
{
  print ("not found.\n");
  print ("\nError: string is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for system library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_system.a")
{
  print ("found.\n");

  push (@libraries, "system");
}
else
{
  print ("not found.\n");
  print ("\nError: system is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for memory library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_memory.a")
{
  print ("found.\n");

  push (@libraries, "memory");
}
else
{
  print ("not found.\n");
  print ("\nError: memory is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for network library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_network.a")
{
  print ("found.\n");

  push (@libraries, "network");
}
else
{
  print ("not found.\n");
  print ("\nError: network is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for mutex library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_mutex.a")
{
  print ("found.\n");

  push (@libraries, "mutex");
}
else
{
  print ("not found.\n");
  print ("\nError: mutex is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for random library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_random.a")
{
  print ("found.\n");

  push (@libraries, "random");
}
else
{
  print ("not found.\n");
  print ("\nError: random is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for list library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_list.a")
{
  print ("found.\n");

  push (@libraries, "list");
}
else
{
  print ("not found.\n");
  print ("\nError: list is a required library. Please check your configuration.\n\n");
  exit 1;
}

print ("Checking for time library... ");
if (-f "$chaos_root/data/programming/libraries/static/library_time.a")
{
  print ("found.\n");

  push (@libraries, "time");
}
else
{
  print ("not found.\n");
  print ("\nError: time is a required library. Please check your configuration.\n\n");
  exit 1;
}


my $all_arguments = "";
foreach my $argument (@ARGV)
{
  $all_arguments .= $argument . " ";
}

print ("Checking for autochaos... ");
my $autochaos = `autochaos --version 2> /dev/null`;

my $has_autochaos;
unless ($autochaos)
{
  print ("not found.\n");
  $has_autochaos = undef;
}
else
{
  (my $version) = ($autochaos =~ m/ ([\d\.]+)$/);
  print ("found (version $version).\n");
  $has_autochaos = $version;
}



@headers = (
);

@sources = (
'arp.c',
'dhcp.c',
'forward.c',
'icmp.c',
'ipv4.c',
'route.c',
'socket.c',
'tcp.c',
'udp.c',
);
@objects = ('arp.o',
'dhcp.o',
'forward.o',
'icmp.o',
'ipv4.o',
'route.o',
'socket.o',
'tcp.o',
'udp.o',
);
@deps = ('arp.dep',
'dhcp.dep',
'forward.dep',
'icmp.dep',
'ipv4.dep',
'route.dep',
'socket.dep',
'tcp.dep',
'udp.dep',
);
  print "Writing ./makefile...
";
  open (MAKEFILE, '>' . "./makefile") or
    die ("Could not write to ./makefile: $!\n");
 
# Write the default rules we want.

  print (MAKEFILE <<STOP);
# This makefile was generated by autochaos 0.2.0. Please do not
# tamper with it unless you are very certain about what you are doing.

ALL_ARGUMENTS = $all_arguments

PREFIX = $chaos_root
PACKAGE = ipv4

# Compiler flags.

CFLAGS = -Wall -W -Wshadow -Wpointer-arith -Waggregate-return \\
-Wstrict-prototypes -Wredundant-decls -Winline -Wmissing-prototypes \\
-Werror -Wcast-align -Wbad-function-cast -Wmissing-noreturns -Wsign-compare \\
-Wmissing-declarations -pipe \\
-Wnested-externs -O3 -fno-builtin -funsigned-char -g \$(EXTRA_CFLAGS) \$(DEFINES)

INCLUDES = \\
STOP
print (MAKEFILE <<STOP);
-I. -I\$(PREFIX)/data/programming/c/headers
STOP
    print MAKEFILE "
ALL_OBJECTS =";
      print MAKEFILE " \\\
./arp.o";
      print MAKEFILE " \\\
./dhcp.o";
      print MAKEFILE " \\\
./forward.o";
      print MAKEFILE " \\\
./icmp.o";
      print MAKEFILE " \\\
./ipv4.o";
      print MAKEFILE " \\\
./route.o";
      print MAKEFILE " \\\
./socket.o";
      print MAKEFILE " \\\
./tcp.o";
      print MAKEFILE " \\\
./udp.o";
    print MAKEFILE "
";
print (MAKEFILE <<STOP);

STATIC_LIBRARY_PATH = \$(PREFIX)/data/programming/libraries/static

# Ideally, this would be -lwhatever, but we have not started patching
# the GNU tools yet...

STOP

  print (MAKEFILE "LIBS = ");
  foreach my $library (@libraries)
  {
    print MAKEFILE "\\\
\$(STATIC_LIBRARY_PATH)/library_$library.a ";
  }

  if (scalar @objects > 0)
  {
    print MAKEFILE "\n\nOBJECTS = ";
    foreach my $object (@objects)
    {
      print MAKEFILE " \\\
$object";
    }
    print MAKEFILE "\
";
  }

  if (scalar @headers > 0)
  {
    print MAKEFILE "\n\nHEADERS = ";
    foreach my $header (@headers)
    {
      print MAKEFILE " \\\
$header";
    }
    print MAKEFILE "\
";
  }

  if (scalar @sources > 0)
  {
    print MAKEFILE "\n\nSOURCES = ";
    foreach my $source (@sources)
    {
      print MAKEFILE " \\\
$source";
    }
    print MAKEFILE "\
";
    
  }

  print (MAKEFILE <<STOP);

HEADER_PATH = \$(PREFIX)/data/programming/c/headers/\$(PACKAGE)/.

# TODO: Those should be overridable.

CC = gcc
NASM = nasm
AR = ar
RANLIB = ranlib
GZIP = gzip -f

%.o: %.c
	\@echo Compiling \$<...
	\@\$(CC) -o \$(@) \$(CFLAGS) \$(INCLUDES) \$(DEFS) -c \$<
	\@\$(CC) -M \$< \$(CFLAGS) \$(INCLUDES) \$(DEFS) > \$(*F).dep

%.o: %.S
	\@echo Compiling \$<...
	\@\$(CC) -o \$(@) \$(CFLAGS) \$(INCLUDES) \$(DEFS) -c \$<
	\@\$(CC) -M \$< \$(CFLAGS) \$(INCLUDES) \$(DEFS) > \$(*F).dep

%.o: %.asm
	\$(NASM) -o \$(@) \$< -f elf

.PHONY: splash all clean install package-source

STOP
 
  {
    my $target = "ipv4" if (scalar @objects);

    unless ($target)
    {
      $target = "";
    }

    print (MAKEFILE <<STOP);
all: splash makefile $target
STOP

  }
    if (!(scalar @objects) && 'ipv4' ne '\$(OBJECTS)')
    {
  print (MAKEFILE <<STOP);
	\@\$(MAKE) ipv4
STOP
    }
  print (MAKEFILE <<STOP);

clean: makefile
STOP
    print MAKEFILE "	rm -f ipv4
";
  if (scalar @objects > 0)
  {
    print MAKEFILE "	rm -f \$(OBJECTS)
";
  }
  print (MAKEFILE <<STOP);
	rm -f *.dep
	-\$(MAKE) clean-local
STOP

# FIXME: Pass all parameters to the configure script at this
# point. Also, make sure the make process is restarted. (fork?)

# FIXME: Support conditional gzipping.
     print (MAKEFILE <<STOP);
makefile: configure
	@./configure

splash:
	\@echo -e "\\n  Compiling server: ipv4...\\n"

STOP

   if ($has_autochaos)
   {
     print (MAKEFILE <<STOP);
configure: autochaos.rules
	\@autochaos

STOP
   }
     print (MAKEFILE <<STOP);

LDFLAGS = \$(PREFIX)/data/programming/c/startup/startup.o \\
-nostdlib -Wl,-T,\$(PREFIX)/data/programming/linker/chaos.ld -lgcc \$(EXTRA_LDFLAGS)

ipv4: \$(OBJECTS)
	\@echo "Linking..."
	\@\$(CC) -o \$(\@) \$(OBJECTS) \$(LIBS) \$(LDFLAGS)

install: all
	mkdir -p \$(PREFIX)/system/servers
	cp ipv4 \$(PREFIX)/system/servers
	strip -R .note -R .comment -R .eh_frame \$(PREFIX)/system/servers/ipv4
	\$(GZIP) \$(PREFIX)/system/servers/ipv4 # > \$(PREFIX)/system/servers/ipv4.gz
STOP
  print (MAKEFILE "\n");

  print (MAKEFILE <<STOP);
package-source:
STOP
print (MAKEFILE <<STOP);
	mkdir -p $root_dir/package-source/.
STOP
    print (MAKEFILE <<STOP);
	-cp -f autochaos.rules changelog configure README AUTHORS TODO INSTALL $root_dir/package-source/.
STOP

  print (MAKEFILE <<STOP);
	-cp -f makefile.template \$(EXTRA_FILES) $root_dir/package-source/.
STOP
     
    if (scalar @headers > 0)
    {
      print (MAKEFILE <<STOP);
	for header in \$(HEADERS) ; do cp \$\$header $root_dir/package-source/. ; done
STOP
    }

    if (scalar @sources > 0)
    {
      print (MAKEFILE <<STOP);
	for source in \$(SOURCES) ; do cp \$\$source $root_dir/package-source/. ; done
STOP
    }

  print (MAKEFILE <<STOP);
package-check: package-source
	     cd package-source && ./configure \$(ALL_ARGUMENTS) && \$(MAKE) && \$(MAKE) clean
	     find package-source -name makefile -exec rm {} ';'
	     rm package-source/config.h
STOP

  print (MAKEFILE <<STOP);
package: package-check
	rm -rf ipv4-0.0.1
	mv package-source ipv4-0.0.1
	tar cvIf ipv4-0.0.1.tar.bz2 ipv4-0.0.1
	     
STOP

  # Include automatically generated dependencies.

  if (scalar @deps > 0)
  {
    foreach my $dep (@deps)
    {
      print (MAKEFILE "-include $dep\n");
    }
  }

  print (MAKEFILE "\n");

  if (open (TEMPLATE, "." . "/makefile.template"))
  {
    while (<TEMPLATE>)
    {
      my $row = $_;

      print (MAKEFILE $row);
    }
  }
  close (MAKEFILE);


  # Now, also write to the config.h

  print "Writing config.h...\
";
  my $CONFIG;
  open (CONFIG, '>config.h');
  print (CONFIG <<STOP);
/* Automatically generated by autochaos 0.2.0. Not intended to be
   hand edited. */

#ifndef __CONFIG_H__
#define __CONFIG_H__

#define PACKAGE_NAME "ipv4"
#define PACKAGE_VERSION "0.0.1"

STOP

  foreach my $option (keys %options)
  {
    print (CONFIG "#define OPTION_" . uc ($option) . " $options{$option}\n");
  }

  foreach my $library (@libraries)
  {
    print (CONFIG "#include <$library/$library.h>\n");
  }

  print (CONFIG "\n#endif /* !__CONFIG_H__ */\n");

  close (CONFIG);
