
TARGET="partition"
GROUP="Modules"

SOURCES_DIR=$CHAOS_SOURCES/$GROUP/Block/Partition
ARCHIVES_DIR=$CHAOS_ARCHIVES/$GROUP

case "$1" in
"-r") 
	BUILD=Release
	COMPILE_FLAGS="-O3 -funroll-loops -fomit-frame-pointer"
    PREPROCESSOR_FLAGS=""
    ;;
"-d") 
	BUILD=Debug
    COMPILE_FLAGS="-O0 -g"
    PREPROCESSOR_FLAGS=""
    ;;
"-g") 
	BUILD=DebugGDB
    COMPILE_FLAGS="-O0 -g -ggdb"
    PREPROCESSOR_FLAGS="-DGDB -DGDB_PORT=0 -DGDB_SPEED=9600"
    ;;

"-as")
	DATE_STRING=`date +%Y%m%d`
	make -s package-source \
    	date_string="$DATE_STRING" \
	    source_directory=$SOURCES_DIR \
        archive_directory="$ARCHIVES_DIR" \
	    --makefile=$SOURCES_DIR/Makefile
	exit
	;;
*) exit
esac

case "$2" in
"-s")
	FORMAT="Static"
	PREPROCESSOR_FLAGS="-D__STORM_KERNEL__ $PREPROCESSOR_FLAGS"
	BINARY_NAME="$TARGET.a"
	;;
"-d")
        echo "Format: Dynamic module"
	FORMAT="Dynamic"
	PREPROCESSOR_FLAGS="-D__STORM_KERNEL_MODULE__ $PREPROCESSOR_FLAGS"
	BINARY_NAME="$TARGET.so"
	LIBRARIES="string.a irq_event.a"
	;;
"-p")
        echo "Format: Server"
	FORMAT="Server"
	PREPROCESSOR_FLAGS="-D__STORM_PROGRAM__ $PREPROCESSOR_FLAGS"
	BINARY_NAME="$TARGET"
	LIBRARIES="string.a irq_event.a"
	;;
*)
	FORMAT="Static"
	PREPROCESSOR_FLAGS="-D__STORM_KERNEL__ $PREPROCESSOR_FLAGS"
	BINARY_NAME="$TARGET.a"
esac

BINARIES_DIR=$CHAOS_BINARIES/$BUILD/$GROUP/$FORMAT
TARGET_NAME=$BINARIES_DIR/$BINARY_NAME
OBJECTS_DIR=$CHAOS_OBJECTS/$BUILD/$GROUP/$FORMAT/$TARGET

LOG_FILE=$OBJECTS_DIR/log

mkdir -p $BINARIES_DIR
mkdir -p $OBJECTS_DIR

make -s deps \
    preprocessor_flags="$PREPROCESSOR_FLAGS" \
    include_directories="$CHAOS_INCLUDES" \
    source_directory=$SOURCES_DIR \
    --directory=$OBJECTS_DIR \
    --makefile=$SOURCES_DIR/Makefile


make -s $TARGET_NAME \
    target=$BINARIES_DIR/$TARGET \
    compile_flags="$COMPILE_FLAGS" \
    preprocessor_flags="$PREPROCESSOR_FLAGS" \
    include_directories="$CHAOS_INCLUDES" \
    library_directories="$CHAOS_LIBRARIES" \
    libraries="$LIBRARIES" \
    source_directory=$SOURCES_DIR \
    --directory=$OBJECTS_DIR \
    --makefile=$SOURCES_DIR/Makefile

