#! /usr/bin/perl -w

# Abstract: Script for configuring this package.

# Copyright 2000 chaos development. This script is in the public domain.

# Please note that this script was automatically generated by
# autochaos 0.2.0. It should not be modified. Do the changes you
# want in autochaos instead.

use strict;
use POSIX;

my $default_root = "/";
my $chaos_root = undef;
my @libraries = ();
my @headers = ();
my @sources = ();
my @objects = ();
my @deps = ();
my $MAKEFILE;
my $TEMPLATE;
my $root_dir = getcwd ();
my %options = 
(
);

my $install_prefix_flag = 0;

foreach my $argument (@ARGV)
{
  if ($install_prefix_flag eq 1)
  {
    $default_root = $argument;
    $install_prefix_flag = 0;
  }
  else
  {
    if ($argument eq '--install-prefix')
    {
      $install_prefix_flag = 1;
    }
    elsif ($argument =~ m/--enable-.*$/)
    {
      (my $option) = ($argument =~ m/--enable-(.*)$/);

      if ($options{$option})
      {
        $options{$option} = 'TRUE';
      }
      else
      {
        print "Unrecognised command line option.\n";
        exit 1;
      }
    }
    elsif ($argument =~ m/--disable-.*$/)
    {
      (my $option) = ($argument =~ m/--disable-(.*)$/);

      if ($options{$option})
      {
        $options{$option} = 'FALSE';
      }
      else
      {
        print "Unrecognised command line option.\n";
        exit 1;
      }
    }
    else
    {
      print "Unrecognised command line option.\n";
      exit 1;
    }
  }
}

if ($install_prefix_flag eq 1)
{
  print "Malformed --install-prefix command option. Value missing.\n";
  exit 1;
}

print "\n  Configuring library: system...\n\n";

print ("Detecting chaos root...\n");

print "Trying default root ($default_root)... ";

if (-d "$default_root/system/kernel")
{
  print "found.\n";
  $chaos_root = $default_root;
}
else
{
  print "not found.\n";

  print "Trying /mnt/chaos... ";

  if (-d "/mnt/chaos/system/kernel")
  {
    print "found.\n";
    $chaos_root = "/mnt/chaos";
  }

  unless ($chaos_root)
  {
    $chaos_root = "/tmp/chaos";
    print "not found.\nFalling back to $chaos_root.\n";
  }
}


my $all_arguments = "";
foreach my $argument (@ARGV)
{
  $all_arguments .= $argument . " ";
}

print ("Checking for autochaos... ");
my $autochaos = `autochaos --version 2> /dev/null`;

my $has_autochaos;
unless ($autochaos)
{
  print ("not found.\n");
  $has_autochaos = undef;
}
else
{
  (my $version) = ($autochaos =~ m/ ([\d\.]+)$/);
  print ("found (version $version).\n");
  $has_autochaos = $version;
}



@headers = (
'alignment.h',
'big_endian.h',
'bit.h',
'byte_order.h',
'endian.h',
'functions.h',
'little_endian.h',
'port.h',
'return_values.h',
'system.h',
'system_calls.h',
);

@sources = (
'system.c',
);
@objects = ('system.o',
);
@deps = ('system.dep',
);
  print "Writing ./makefile...
";
  open (MAKEFILE, '>' . "./makefile") or
    die ("Could not write to ./makefile: $!\n");
 
# Write the default rules we want.

  print (MAKEFILE <<STOP);
# This makefile was generated by autochaos 0.2.0. Please do not
# tamper with it unless you are very certain about what you are doing.

ALL_ARGUMENTS = $all_arguments

PREFIX = $chaos_root
PACKAGE = system

# Compiler flags.

CFLAGS = -Wall -W -Wshadow -Wpointer-arith -Waggregate-return \\
-Wstrict-prototypes -Wredundant-decls -Winline -Wmissing-prototypes \\
-Werror -Wcast-align -Wbad-function-cast -Wmissing-noreturns -Wsign-compare \\
-Wmissing-declarations -pipe \\
-Wnested-externs -O3 -fno-builtin -funsigned-char -g \$(EXTRA_CFLAGS) \$(DEFINES)

INCLUDES = \\
STOP
  print MAKEFILE "-I.. \\\
";
print (MAKEFILE <<STOP);
-I. -I\$(PREFIX)/data/programming/c/headers
STOP
    print MAKEFILE "
ALL_OBJECTS =";
      print MAKEFILE " \\\
./system.o";
    print MAKEFILE "
";
print (MAKEFILE <<STOP);

STATIC_LIBRARY_PATH = \$(PREFIX)/data/programming/libraries/static

# Ideally, this would be -lwhatever, but we have not started patching
# the GNU tools yet...

STOP

  print (MAKEFILE "LIBS = ");
  foreach my $library (@libraries)
  {
    print MAKEFILE "\\\
\$(STATIC_LIBRARY_PATH)/library_$library.a ";
  }

  if (scalar @objects > 0)
  {
    print MAKEFILE "\n\nOBJECTS = ";
    foreach my $object (@objects)
    {
      print MAKEFILE " \\\
$object";
    }
    print MAKEFILE "\
";
  }

  if (scalar @headers > 0)
  {
    print MAKEFILE "\n\nHEADERS = ";
    foreach my $header (@headers)
    {
      print MAKEFILE " \\\
$header";
    }
    print MAKEFILE "\
";
  }

  if (scalar @sources > 0)
  {
    print MAKEFILE "\n\nSOURCES = ";
    foreach my $source (@sources)
    {
      print MAKEFILE " \\\
$source";
    }
    print MAKEFILE "\
";
    
  }

  print (MAKEFILE <<STOP);

HEADER_PATH = \$(PREFIX)/data/programming/c/headers/\$(PACKAGE)/.

# TODO: Those should be overridable.

CC = gcc
NASM = nasm
AR = ar
RANLIB = ranlib
GZIP = gzip -f

%.o: %.c
	\@echo Compiling \$<...
	\@\$(CC) -o \$(@) \$(CFLAGS) \$(INCLUDES) \$(DEFS) -c \$<
	\@\$(CC) -M \$< \$(CFLAGS) \$(INCLUDES) \$(DEFS) > \$(*F).dep

%.o: %.S
	\@echo Compiling \$<...
	\@\$(CC) -o \$(@) \$(CFLAGS) \$(INCLUDES) \$(DEFS) -c \$<
	\@\$(CC) -M \$< \$(CFLAGS) \$(INCLUDES) \$(DEFS) > \$(*F).dep

%.o: %.asm
	\$(NASM) -o \$(@) \$< -f elf

.PHONY: splash all clean install package-source

STOP
 
  {
    my $target = "library_system.a" if (scalar @objects);

    unless ($target)
    {
      $target = "";
    }

    print (MAKEFILE <<STOP);
all: splash makefile $target
STOP

  }
    if (!(scalar @objects) && 'library_system.a' ne '\$(OBJECTS)')
    {
  print (MAKEFILE <<STOP);
	\@\$(MAKE) library_system.a
STOP
    }
  print (MAKEFILE <<STOP);

clean: makefile
STOP
    print MAKEFILE "	rm -f library_system.a
";
  if (scalar @objects > 0)
  {
    print MAKEFILE "	rm -f \$(OBJECTS)
";
  }
  print (MAKEFILE <<STOP);
	rm -f *.dep
	-\$(MAKE) clean-local
STOP

# FIXME: Pass all parameters to the configure script at this
# point. Also, make sure the make process is restarted. (fork?)

# FIXME: Support conditional gzipping.
     print (MAKEFILE <<STOP);
makefile: configure
	@./configure

splash:
	\@echo -e "\\n  Compiling library: system...\\n"

STOP

   if ($has_autochaos)
   {
     print (MAKEFILE <<STOP);
configure: autochaos.rules
	\@autochaos

STOP
   }
     print (MAKEFILE <<STOP);

LDFLAGS = \$(PREFIX)/data/programming/c/startup/startup.o \\
-nostdlib -Wl,-T,\$(PREFIX)/data/programming/linker/chaos.ld -lgcc \$(EXTRA_LDFLAGS)

library_system.a: \$(OBJECTS)
	\@echo "Creating library..."
	\@\$(AR) cru \$(\@) \$(OBJECTS)
	\@\$(RANLIB) \$(\@)

install: all
	mkdir -p \$(PREFIX)/data/programming/libraries/static
	cp library_system.a \$(PREFIX)/data/programming/libraries/static
	mkdir -p \$(PREFIX)/data/programming/c/headers/\$(PACKAGE)
	for header in \$(HEADERS) ; do cp \$\$header \$(PREFIX)/data/programming/c/headers/\$(PACKAGE) ; done
STOP
  print (MAKEFILE "\n");

  print (MAKEFILE <<STOP);
package-source:
STOP
print (MAKEFILE <<STOP);
	mkdir -p $root_dir/package-source/.
STOP
    print (MAKEFILE <<STOP);
	-cp -f autochaos.rules changelog configure README AUTHORS TODO INSTALL $root_dir/package-source/.
STOP

  print (MAKEFILE <<STOP);
	-cp -f makefile.template \$(EXTRA_FILES) $root_dir/package-source/.
STOP
     
    if (scalar @headers > 0)
    {
      print (MAKEFILE <<STOP);
	for header in \$(HEADERS) ; do cp \$\$header $root_dir/package-source/. ; done
STOP
    }

    if (scalar @sources > 0)
    {
      print (MAKEFILE <<STOP);
	for source in \$(SOURCES) ; do cp \$\$source $root_dir/package-source/. ; done
STOP
    }

  print (MAKEFILE <<STOP);
package-check: package-source
	     cd package-source && ./configure \$(ALL_ARGUMENTS) && \$(MAKE) && \$(MAKE) clean
	     find package-source -name makefile -exec rm {} ';'
	     rm package-source/config.h
STOP

  print (MAKEFILE <<STOP);
package: package-check
	rm -rf system-0.0.1
	mv package-source system-0.0.1
	tar cvIf system-0.0.1.tar.bz2 system-0.0.1
	     
STOP

  # Include automatically generated dependencies.

  if (scalar @deps > 0)
  {
    foreach my $dep (@deps)
    {
      print (MAKEFILE "-include $dep\n");
    }
  }

  print (MAKEFILE "\n");

  if (open (TEMPLATE, "." . "/makefile.template"))
  {
    while (<TEMPLATE>)
    {
      my $row = $_;

      print (MAKEFILE $row);
    }
  }
  close (MAKEFILE);


  # Now, also write to the config.h

  print "Writing config.h...\
";
  my $CONFIG;
  open (CONFIG, '>config.h');
  print (CONFIG <<STOP);
/* Automatically generated by autochaos 0.2.0. Not intended to be
   hand edited. */

#ifndef __CONFIG_H__
#define __CONFIG_H__

#define PACKAGE_NAME "system"
#define PACKAGE_VERSION "0.0.1"

STOP

  foreach my $option (keys %options)
  {
    print (CONFIG "#define OPTION_" . uc ($option) . " $options{$option}\n");
  }

  foreach my $library (@libraries)
  {
    print (CONFIG "#include <$library/$library.h>\n");
  }

  print (CONFIG "\n#endif /* !__CONFIG_H__ */\n");

  close (CONFIG);
